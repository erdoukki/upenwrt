# upenwrt

`upenwrt` is a tool, in form of a (simple) HTTP server, that generates custom
[OpenWRT][1] sysupgrade images with all your user-installed packages baked in,
on the fly.

It is designed to aid end-user upgrade process (saving you the hassle of
reinstalling all your packages by hand), especially if the target device relies
on non-default packages for Internet connectivity.

# usage

Assuming that the daemon is reachable at <http://upenwrt:8000>:

```
curl http://upenwrt:8000 | sh > /tmp/sysupgrade.img
sysupgrade -v /tmp/sysupgrade.img
```

Files read by the script:

* `/etc/openwrt_release`
* `/tmp/sysinfo/board_name`
* `/usr/lib/opkg/status`

Environment variables (optionally) used by the script:

* `$TARGET_NAME`: OpenWRT target name, e. g. `ramips/mt7621` (overrides `$DISTRIB_TARGET` of `/etc/openwrt_release`)
* `$BOARD_NAME`: OpenWRT board name or profile name, e. g. `xiaomi,mir3g` or `mir3g` (overrides `/tmp/sysinfo/board_name`)
* `$RELEASE`: current (installed) OpenWRT release, e. g. `snapshot` (overrides `$DISTRIB_RELEASE` of `/etc/openwrt_release`)
* `$REVISION`: current (installed) OpenWRT revision, e. g. `r10574-273b803623` (overrides `$DISTRIB_REVISION` of `/etc/openwrt_release`)
* `$PACKAGES`: list of packages to install into the image, space-separated (overrides `/usr/lib/opkg/status`)

# description

`upenwrt` is implemented as a (simple) HTTP server daemon that serves a script
(`/get.sh`) and a single API endpoint (`/api/get`).

The script must be executed on the target device (presumably in the infamous
`curl | sh` pattern) and will collect user-installed package lists and other
necessary metadata. The API endpoint is supposed to be called by the script
and will return the resulting image in the response body (which will be written
on stdout).

# daemon usage

The daemon keeps all of its data in its "root directory", henceforth `$rootdir`.

Inside its `$rootdir`, the daemon needs:
* a copy of its static file tree under `$rootdir/static`
  (included in upenwrt source tree as `root/static`)
* a copy of [OpenWRT git repository][2] under `$rootdir/repo/openwrt.git`
  (bring your own and fetch regularly, upenwrt will not update it)
* an empty cache directory `$rootdir/cache`
* an empty work directory `$rootdir/work`

It is advised to put the work directory (`$rootdir/work`) on tmpfs and the cache
directory (`$rootdir/cache`) on a persistent read-write medium with sufficient
storage capacity for a few imagebuilders.

In other words:

```
mkdir -p /var/lib/upenwrt
cp -r root/static -T /var/lib/upenwrt/static
mkdir -p /var/lib/upenwrt/repo; git clone --bare https://git.openwrt.org/openwrt/openwrt.git /var/lib/upenwrt/repo/openwrt.git
mkdir -p /var/lib/upenwrt/cache
mkdir -p /var/lib/upenwrt/work; mount tmpfs -t tmpfs /var/lib/upenwrt/work
./upenwrt.py --rootdir /var/lib/upenwrt --baseurl http://upenwrt:8000 --listen '0.0.0.0' --port 8000
```

# trivia

The main problem is to separate truly user-installed packages from default
packages (which are marked "user" in the opkg database as well), because while
it is possible to pass all "user" packages to `make image`, the default package
set is much more prone to change between revisions than user packages.

The obvious idea would be to compare opkg databases between the squashfs and the
overlay. However, this will not work if the user already runs an image with some
of their packages baked in (or, by extension, if the tool is used twice or more
in a row). The only viable idea known to the author is to get a vanilla openwrt
image of a matching revision and use its package list as the base.

However, it is infeasible to download and keep vanilla images corresponding to
all possible source revisions (as they are, naturally, rotated daily). Instead,
the openwrt source tree is downloaded and cached. Upon each request, the source
tree is checked out at the revision matching the pre-existing firmware and
targetinfo files are generated by calling the buildsystem. "Vanilla" package
lists are then extracted from targetinfo files and subtracted from submitted
package lists.
